<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments :: head}"></head>

<body class="aura-page">
<link rel="stylesheet" th:href="@{/css/aura.css}"/>
<link rel="stylesheet" th:href="@{/css/capture.css}"/>
<div th:replace="~{fragments :: header}"></div>

<!-- Hero Section -->
<div class="aura-hero">
    <h1><i class="fas fa-rocket mr-2"></i> Complete Your Profile</h1>
    <p>Answer a few questions and upload a video to start matching</p>
</div>

<div class="aura-container">
    <!-- Progress Overview -->
    <div class="aura-card aura-animate-fade-up">
        <div class="intake-progress-header">
            <h2>Your Progress</h2>
            <div class="progress-percentage" id="overall-progress">0%</div>
        </div>
        <div class="aura-progress-bar" style="height: 12px; margin: 1rem 0;">
            <div id="progress-fill" class="aura-progress-fill" style="width: 0%;"></div>
        </div>

        <div class="intake-steps">
            <div class="intake-step" id="step-questions">
                <div class="step-icon pending"><i class="fas fa-question-circle"></i></div>
                <div class="step-info">
                    <strong>Core Questions</strong>
                    <p>Answer 10 questions about your values and preferences</p>
                </div>
                <div class="step-status" id="step-questions-status">
                    <span class="badge pending">Pending</span>
                </div>
            </div>

            <div class="intake-step" id="step-video">
                <div class="step-icon pending"><i class="fas fa-video"></i></div>
                <div class="step-info">
                    <strong>Video Introduction</strong>
                    <p>Record a short video to introduce yourself</p>
                </div>
                <div class="step-status" id="step-video-status">
                    <span class="badge pending">Pending</span>
                </div>
            </div>

            <div class="intake-step" id="step-photos">
                <div class="step-icon pending"><i class="fas fa-images"></i></div>
                <div class="step-info">
                    <strong>Profile Photos</strong>
                    <p>Upload at least one photo</p>
                </div>
                <div class="step-status" id="step-photos-status">
                    <span class="badge pending">Pending</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Current Step Content -->
    <div id="current-step-content" class="aura-card aura-animate-fade-up" style="margin-top: 1rem;">
        <!-- Step 1: Core Questions -->
        <div id="questions-section" class="step-section">
            <div class="aura-card-header">
                <div class="aura-card-icon"><i class="fas fa-question-circle"></i></div>
                <div>
                    <div class="aura-card-title">Core Questions</div>
                    <div class="aura-card-subtitle">One question from each category</div>
                </div>
            </div>

            <div id="questions-container">
                <!-- Questions will be loaded dynamically -->
                <div class="loading-spinner">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p>Loading questions...</p>
                </div>
            </div>

            <div id="questions-navigation" style="display: none;">
                <div class="question-progress">
                    Question <span id="current-question">1</span> of <span id="total-questions">10</span>
                </div>
                <div class="question-buttons">
                    <button class="aura-btn aura-btn-outline" id="prev-question" disabled>
                        <i class="fas fa-arrow-left"></i> Previous
                    </button>
                    <button class="aura-btn aura-btn-primary" id="next-question">
                        Next <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 2: Video/Audio Introduction -->
        <div id="video-section" class="step-section" style="display: none;">
            <div class="aura-card-header">
                <div class="aura-card-icon"><i class="fas fa-microphone-alt"></i></div>
                <div>
                    <div class="aura-card-title">Introduce Yourself</div>
                    <div class="aura-card-subtitle">Record a voice or video intro for potential matches</div>
                </div>
            </div>

            <!-- Mode Selection -->
            <div id="intro-mode-select" class="intro-mode-section">
                <p class="intro-mode-label">How would you like to introduce yourself?</p>
                <div class="intro-mode-grid">
                    <div class="intro-mode-card recommended" onclick="selectIntroMode('AUDIO_ONLY')">
                        <div class="intro-mode-badge">Recommended</div>
                        <div class="intro-mode-icon" style="background: linear-gradient(135deg, #10b981, #34d399);">
                            <i class="fas fa-microphone"></i>
                        </div>
                        <div class="intro-mode-title">Voice Only</div>
                        <div class="intro-mode-desc">Record a voice message. Simple and works everywhere.</div>
                    </div>
                    <div class="intro-mode-card" onclick="selectIntroMode('WEBCAM_MIC')">
                        <div class="intro-mode-icon" style="background: linear-gradient(135deg, #ec4899, #f472b6);">
                            <i class="fas fa-video"></i>
                        </div>
                        <div class="intro-mode-title">Video</div>
                        <div class="intro-mode-desc">Show your face and personality on camera.</div>
                    </div>
                </div>
            </div>

            <!-- Recording Interface (shown after mode selection) -->
            <div id="intro-recording-ui" style="display: none;">
                <div class="intro-tips">
                    <h4><i class="fas fa-lightbulb"></i> <span id="intro-tips-title">Tips for a great intro:</span></h4>
                    <ul id="intro-tips-list">
                        <li>Share your name and what you're looking for</li>
                        <li>Mention a hobby or interest</li>
                        <li>Say what makes you unique</li>
                        <li>Keep it under 2 minutes</li>
                    </ul>
                </div>

                <!-- Audio Visualizer (for audio mode) -->
                <div id="intro-audio-visualizer" class="capture-audio-visualizer-container">
                    <div class="capture-audio-wave" id="intro-audio-wave">
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                    </div>
                    <div id="intro-audio-status" class="capture-audio-status">
                        <i class="fas fa-microphone"></i>
                        <span>Ready to record</span>
                    </div>
                </div>

                <!-- Video Preview (for video mode) -->
                <div id="intro-video-preview" class="capture-preview-container" style="display: none;">
                    <video id="intro-preview-video" autoplay playsinline muted></video>
                    <div class="capture-face-guide"></div>
                </div>

                <!-- Recording Indicator -->
                <div id="intro-recording-indicator" class="capture-recording-indicator" style="display: none;">
                    <span class="capture-recording-dot"></span>
                    <span>REC</span>
                    <span id="intro-recording-time">0:00</span>
                </div>

                <!-- Progress Bar -->
                <div class="capture-progress-container">
                    <div class="aura-progress-bar">
                        <div id="intro-recording-progress" class="aura-progress-fill" style="width: 0%;"></div>
                    </div>
                    <div id="intro-time-limit" class="capture-time-hint">Maximum: 2:00</div>
                </div>

                <!-- Controls -->
                <div class="capture-controls">
                    <button id="intro-record-btn" class="capture-btn-record" onclick="toggleIntroRecording()">
                        <span class="record-icon"><i class="fas fa-circle"></i></span>
                        <span id="intro-record-text">Start Recording</span>
                    </button>
                </div>

                <div id="intro-secondary-controls" class="capture-secondary-controls" style="display: none;">
                    <button class="aura-btn aura-btn-secondary" onclick="changeIntroMode()">
                        <i class="fas fa-arrow-left"></i> Change Mode
                    </button>
                    <button class="aura-btn aura-btn-danger" onclick="cancelIntroRecording()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>

                <!-- Upload Progress -->
                <div id="intro-upload-progress" style="display: none; margin-top: 1.5rem;">
                    <div class="aura-progress-bar" style="height: 8px;">
                        <div id="intro-upload-bar" class="aura-progress-fill" style="width: 0%;"></div>
                    </div>
                    <div id="intro-upload-text" style="text-align: center; margin-top: 0.5rem; color: var(--aura-primary);">
                        Uploading... 0%
                    </div>
                </div>
            </div>

            <!-- Skip Option -->
            <div class="intro-skip-option" style="margin-top: 1.5rem; text-align: center;">
                <button class="aura-btn aura-btn-outline aura-btn-sm" onclick="skipIntro()">
                    <i class="fas fa-forward"></i> Skip for now
                </button>
                <p style="font-size: 0.75rem; color: var(--aura-gray-500); margin-top: 0.5rem;">
                    You can add an intro later from your profile settings.
                </p>
            </div>
        </div>

        <!-- Step 3: Photos -->
        <div id="photos-section" class="step-section" style="display: none;">
            <div class="aura-card-header">
                <div class="aura-card-icon"><i class="fas fa-images"></i></div>
                <div>
                    <div class="aura-card-title">Profile Photos</div>
                    <div class="aura-card-subtitle">Upload at least one photo</div>
                </div>
            </div>

            <div class="photos-grid" id="photos-grid">
                <div class="photo-slot empty" onclick="document.getElementById('photo-input').click()">
                    <i class="fas fa-plus"></i>
                    <span>Add Photo</span>
                </div>
            </div>
            <input type="file" id="photo-input" accept="image/*" multiple style="display: none;">

            <div class="photo-tips">
                <p><i class="fas fa-info-circle"></i> Tips: Use clear, recent photos showing your face. Avoid group photos as your main picture.</p>
            </div>
        </div>
    </div>

    <!-- Completion Section -->
    <div id="completion-section" class="aura-card aura-animate-fade-up" style="margin-top: 1rem; display: none;">
        <div style="text-align: center; padding: 2rem;">
            <div class="completion-icon">
                <i class="fas fa-check-circle fa-4x" style="color: var(--aura-success);"></i>
            </div>
            <h2 style="margin-top: 1.5rem; color: var(--aura-success);">Profile Complete!</h2>
            <p style="color: var(--aura-gray-500); margin-top: 0.5rem;">
                You're ready to start matching with compatible people.
            </p>
            <a href="/" class="aura-btn aura-btn-primary aura-btn-lg" style="margin-top: 1.5rem;">
                <i class="fas fa-heart"></i> Start Matching
            </a>
        </div>
    </div>
</div>

<div th:replace="~{fragments :: footer}"></div>

<!-- WebCapture Library for Audio/Video Recording -->
<script th:src="@{/js/web-capture.js}"></script>

<style>
    .intake-progress-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .progress-percentage {
        font-size: 1.5rem;
        font-weight: 700;
        background: var(--aura-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .intake-steps {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-top: 1.5rem;
    }

    .intake-step {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: var(--aura-gray-50);
        border-radius: 12px;
        transition: all 0.3s ease;
    }

    .intake-step.active {
        background: linear-gradient(135deg, rgba(124, 58, 237, 0.1), rgba(168, 85, 247, 0.1));
        border: 2px solid var(--aura-primary);
    }

    .intake-step.completed {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.1));
    }

    .step-icon {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        flex-shrink: 0;
    }

    .step-icon.pending {
        background: var(--aura-gray-200);
        color: var(--aura-gray-500);
    }

    .step-icon.active {
        background: var(--aura-gradient);
        color: white;
    }

    .step-icon.completed {
        background: var(--aura-success);
        color: white;
    }

    .step-info {
        flex: 1;
    }

    .step-info strong {
        display: block;
        color: var(--aura-gray-800);
    }

    .step-info p {
        font-size: 0.875rem;
        color: var(--aura-gray-500);
        margin-top: 0.25rem;
    }

    .badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .badge.pending {
        background: var(--aura-gray-200);
        color: var(--aura-gray-600);
    }

    .badge.active {
        background: var(--aura-primary);
        color: white;
    }

    .badge.completed {
        background: var(--aura-success);
        color: white;
    }

    .step-section {
        padding: 1rem 0;
    }

    .question-card {
        padding: 2rem;
        text-align: center;
    }

    .question-text {
        font-size: 1.25rem;
        font-weight: 500;
        color: var(--aura-gray-800);
        margin-bottom: 1.5rem;
    }

    .answer-options {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        max-width: 400px;
        margin: 0 auto;
    }

    .answer-option {
        padding: 1rem;
        border: 2px solid var(--aura-gray-200);
        border-radius: 12px;
        background: white;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: left;
    }

    .answer-option:hover {
        border-color: var(--aura-primary);
        background: rgba(124, 58, 237, 0.05);
    }

    .answer-option.selected {
        border-color: var(--aura-primary);
        background: linear-gradient(135deg, rgba(124, 58, 237, 0.1), rgba(168, 85, 247, 0.1));
    }

    .question-progress {
        text-align: center;
        margin-bottom: 1rem;
        color: var(--aura-gray-500);
    }

    .question-buttons {
        display: flex;
        justify-content: center;
        gap: 1rem;
    }

    .video-tips {
        background: var(--aura-gray-50);
        padding: 1rem;
        border-radius: 12px;
        margin-bottom: 1.5rem;
    }

    .video-tips h4 {
        color: var(--aura-primary);
        margin-bottom: 0.5rem;
    }

    .video-tips ul {
        margin: 0;
        padding-left: 1.5rem;
        color: var(--aura-gray-600);
    }

    .video-preview-container {
        position: relative;
        width: 100%;
        max-width: 480px;
        margin: 0 auto;
        border-radius: 16px;
        overflow: hidden;
        background: #000;
        aspect-ratio: 4/3;
    }

    .video-preview-container video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transform: scaleX(-1);
    }

    .video-controls {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-top: 1rem;
    }

    .aura-btn-record {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
    }

    .aura-btn-record.recording {
        animation: pulse 1s infinite;
    }

    .upload-alternative {
        text-align: center;
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid var(--aura-gray-200);
    }

    .photos-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 1rem;
        margin: 1rem 0;
    }

    .photo-slot {
        aspect-ratio: 1;
        border-radius: 12px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }

    .photo-slot.empty {
        border: 2px dashed var(--aura-gray-300);
        background: var(--aura-gray-50);
        color: var(--aura-gray-400);
    }

    .photo-slot.empty:hover {
        border-color: var(--aura-primary);
        color: var(--aura-primary);
    }

    .photo-slot img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .loading-spinner {
        text-align: center;
        padding: 3rem;
        color: var(--aura-gray-500);
    }

    .completion-icon {
        animation: bounceIn 0.5s ease;
    }

    /* OKCupid-style Acceptable Answers Selector (Marriage Machine feature) */
    .acceptable-section {
        margin-top: 1.5rem;
        padding: 1rem;
        background: linear-gradient(135deg, rgba(6, 182, 212, 0.05), rgba(16, 185, 129, 0.05));
        border: 1px solid rgba(6, 182, 212, 0.2);
        border-radius: var(--aura-radius);
    }

    .acceptable-label {
        font-weight: 600;
        color: var(--aura-gray-700);
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .acceptable-label i {
        color: #06b6d4;
    }

    .acceptable-options {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .acceptable-option {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.625rem 0.875rem;
        border: 2px solid var(--aura-gray-200);
        border-radius: var(--aura-radius);
        background: white;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.875rem;
    }

    .acceptable-option:hover {
        border-color: #06b6d4;
        background: rgba(6, 182, 212, 0.05);
    }

    .acceptable-option.selected {
        border-color: #06b6d4;
        background: rgba(6, 182, 212, 0.1);
    }

    .acceptable-option input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: #06b6d4;
    }

    .acceptable-text {
        flex: 1;
        color: var(--aura-gray-700);
    }

    .acceptable-hint {
        margin-top: 0.75rem;
        font-size: 0.8125rem;
        color: var(--aura-gray-500);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .acceptable-hint i {
        color: #06b6d4;
    }

    /* OKCupid-style Importance Selector (Marriage Machine feature) */
    .importance-section {
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid var(--aura-gray-200);
    }

    .importance-label {
        font-weight: 600;
        color: var(--aura-gray-700);
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .importance-label i {
        color: var(--aura-primary);
    }

    .importance-options {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .importance-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.25rem;
        padding: 0.75rem 1rem;
        border: 2px solid var(--aura-gray-200);
        border-radius: var(--aura-radius);
        background: white;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.8125rem;
        font-weight: 500;
        color: var(--aura-gray-600);
        min-width: 80px;
    }

    .importance-btn:hover {
        border-color: var(--aura-primary);
        background: rgba(124, 58, 237, 0.05);
    }

    .importance-btn.selected {
        border-color: var(--aura-primary);
        background: linear-gradient(135deg, rgba(124, 58, 237, 0.1), rgba(168, 85, 247, 0.1));
        color: var(--aura-primary);
    }

    .importance-btn.mandatory {
        border-color: var(--aura-gray-200);
    }

    .importance-btn.mandatory:hover {
        border-color: var(--aura-danger);
        background: rgba(239, 68, 68, 0.05);
    }

    .importance-btn.mandatory.selected {
        border-color: var(--aura-danger);
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.1));
        color: var(--aura-danger);
    }

    .importance-icon {
        font-size: 1.25rem;
    }

    .importance-hint {
        margin-top: 0.75rem;
        font-size: 0.8125rem;
        color: var(--aura-gray-500);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .importance-hint i {
        color: var(--aura-primary);
    }

    @media (max-width: 640px) {
        .importance-options {
            justify-content: center;
        }

        .importance-btn {
            flex: 1 1 calc(33% - 0.5rem);
            min-width: unset;
        }
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }

    @keyframes bounceIn {
        0% { transform: scale(0); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
    }

    /* Intro Mode Selection */
    .intro-mode-section {
        padding: 1rem 0;
    }

    .intro-mode-label {
        font-weight: 500;
        margin-bottom: 1rem;
        text-align: center;
        color: var(--aura-gray-600);
    }

    .intro-mode-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        max-width: 500px;
        margin: 0 auto;
    }

    .intro-mode-card {
        position: relative;
        padding: 1.5rem 1rem;
        border: 2px solid var(--aura-gray-200);
        border-radius: 12px;
        cursor: pointer;
        text-align: center;
        transition: all 0.3s ease;
        background: var(--aura-card-bg, white);
    }

    .intro-mode-card:hover {
        border-color: var(--aura-primary);
        transform: translateY(-2px);
    }

    .intro-mode-card.recommended {
        border-color: var(--aura-success);
    }

    .intro-mode-badge {
        position: absolute;
        top: -10px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--aura-success);
        color: white;
        padding: 0.2rem 0.6rem;
        border-radius: 10px;
        font-size: 0.7rem;
        font-weight: 600;
    }

    .intro-mode-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 0.75rem;
        font-size: 1.25rem;
        color: white;
    }

    .intro-mode-title {
        font-weight: 600;
        margin-bottom: 0.25rem;
    }

    .intro-mode-desc {
        font-size: 0.8rem;
        color: var(--aura-gray-500);
    }

    .intro-tips {
        background: var(--aura-gray-50);
        padding: 1rem;
        border-radius: 12px;
        margin-bottom: 1.5rem;
    }

    .intro-tips h4 {
        color: var(--aura-primary);
        margin-bottom: 0.5rem;
    }

    .intro-tips ul {
        margin: 0;
        padding-left: 1.5rem;
        color: var(--aura-gray-600);
    }

    @media (max-width: 480px) {
        .intro-mode-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (prefers-color-scheme: dark) {
        .intake-step {
            background: var(--aura-gray-800);
        }

        .intake-step.active {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.2), rgba(168, 85, 247, 0.2));
        }

        .step-info strong,
        .question-text {
            color: var(--aura-gray-100);
        }

        .answer-option {
            background: var(--aura-gray-800);
            border-color: var(--aura-gray-600);
        }

        .video-tips {
            background: var(--aura-gray-800);
        }
    }
</style>

<script th:inline="javascript">
    let questions = [];
    let currentQuestionIndex = 0;
    let answers = {};
    let progress = /*[[${progress}]]*/ {};

    document.addEventListener('DOMContentLoaded', function() {
        updateProgressDisplay();
        loadCurrentStep();
    });

    function updateProgressDisplay() {
        let completedSteps = 0;
        let totalSteps = 3;

        if (progress.questionsComplete) {
            completedSteps++;
            document.getElementById('step-questions').classList.add('completed');
            document.getElementById('step-questions-status').innerHTML = '<span class="badge completed">Complete</span>';
        }

        if (progress.videoIntroComplete) {
            completedSteps++;
            document.getElementById('step-video').classList.add('completed');
            document.getElementById('step-video-status').innerHTML = '<span class="badge completed">Complete</span>';
        }

        if (progress.picturesComplete) {
            completedSteps++;
            document.getElementById('step-photos').classList.add('completed');
            document.getElementById('step-photos-status').innerHTML = '<span class="badge completed">Complete</span>';
        }

        let percentage = Math.round((completedSteps / totalSteps) * 100);
        document.getElementById('overall-progress').textContent = percentage + '%';
        document.getElementById('progress-fill').style.width = percentage + '%';

        if (progress.intakeComplete) {
            document.getElementById('current-step-content').style.display = 'none';
            document.getElementById('completion-section').style.display = 'block';
        }
    }

    function loadCurrentStep() {
        if (!progress.questionsComplete) {
            showQuestionsStep();
        } else if (!progress.videoIntroComplete) {
            showVideoStep();
        } else if (!progress.picturesComplete) {
            showPhotosStep();
        }
    }

    async function showQuestionsStep() {
        document.getElementById('step-questions').classList.add('active');
        document.getElementById('step-questions-status').innerHTML = '<span class="badge active">In Progress</span>';

        try {
            const response = await fetch('/intake/questions');
            questions = await response.json();
            renderQuestions();
        } catch (error) {
            console.error('Failed to load questions:', error);
        }
    }

    function renderQuestions() {
        if (questions.length === 0) {
            document.getElementById('questions-container').innerHTML = '<p>No questions available.</p>';
            return;
        }

        document.getElementById('total-questions').textContent = questions.length;
        document.getElementById('questions-navigation').style.display = 'block';
        renderCurrentQuestion();
    }

    // Store importance for each question (OKCupid-style)
    let questionImportance = {};

    // Store acceptable answers for each question (OKCupid-style)
    let acceptableAnswers = {};

    // Get default acceptable answers (same answer ¬±1)
    function getDefaultAcceptable(selectedAnswer, totalOptions) {
        if (selectedAnswer === undefined) return [];
        const acceptable = [selectedAnswer];
        if (selectedAnswer > 0) acceptable.push(selectedAnswer - 1);
        if (selectedAnswer < totalOptions - 1) acceptable.push(selectedAnswer + 1);
        return acceptable.sort((a, b) => a - b);
    }

    // Toggle an acceptable answer
    function toggleAcceptable(questionId, optionIndex) {
        if (!acceptableAnswers[questionId]) {
            // Initialize with default if not set
            const question = questions.find(q => q.id === questionId);
            acceptableAnswers[questionId] = getDefaultAcceptable(
                answers[questionId],
                question?.options?.length || 5
            );
        }

        const idx = acceptableAnswers[questionId].indexOf(optionIndex);
        if (idx > -1) {
            // Don't allow removing the user's own answer
            if (optionIndex === answers[questionId]) {
                return; // Can't uncheck your own answer
            }
            acceptableAnswers[questionId].splice(idx, 1);
        } else {
            acceptableAnswers[questionId].push(optionIndex);
            acceptableAnswers[questionId].sort((a, b) => a - b);
        }
        renderCurrentQuestion();
    }

    function renderCurrentQuestion() {
        const question = questions[currentQuestionIndex];
        document.getElementById('current-question').textContent = currentQuestionIndex + 1;

        let optionsHtml = '';
        if (question.options) {
            question.options.forEach((opt, idx) => {
                const selected = answers[question.id] === idx ? 'selected' : '';
                optionsHtml += `
                    <div class="answer-option ${selected}" onclick="selectAnswer(${question.id}, ${idx})">
                        ${opt}
                    </div>
                `;
            });
        }

        // Get current importance selection (default: 'somewhat')
        const currentImportance = questionImportance[question.id] || 'somewhat';

        // Get acceptable answers for this question (default: same answer ¬±1)
        const currentAcceptable = acceptableAnswers[question.id] || getDefaultAcceptable(answers[question.id], question.options?.length || 5);

        // OKCupid-style acceptable answers selector (Marriage Machine feature)
        let acceptableHtml = '';
        if (answers[question.id] !== undefined && question.options) {
            acceptableHtml = `
                <div class="acceptable-section">
                    <div class="acceptable-label">
                        <i class="fas fa-check-double"></i> What answers would you accept from a partner?
                    </div>
                    <div class="acceptable-options">
                        ${question.options.map((opt, idx) => `
                            <label class="acceptable-option ${currentAcceptable.includes(idx) ? 'selected' : ''}">
                                <input type="checkbox"
                                       ${currentAcceptable.includes(idx) ? 'checked' : ''}
                                       onchange="toggleAcceptable(${question.id}, ${idx})">
                                <span class="acceptable-text">${opt}</span>
                            </label>
                        `).join('')}
                    </div>
                    <div class="acceptable-hint">
                        <i class="fas fa-lightbulb"></i>
                        Select all answers you'd find acceptable. Your match's answer must be one you selected.
                    </div>
                </div>
            `;
        }

        // Get current importance selection (default: 'somewhat')
        const currentImportance = questionImportance[question.id] || 'somewhat';

        // OKCupid-style importance selector (Marriage Machine feature)
        const importanceHtml = `
            <div class="importance-section">
                <div class="importance-label">
                    <i class="fas fa-star"></i> How important is this to you?
                </div>
                <div class="importance-options">
                    <button class="importance-btn ${currentImportance === 'irrelevant' ? 'selected' : ''}"
                            onclick="setImportance(${question.id}, 'irrelevant')" title="Skip this for matching">
                        <span class="importance-icon">ü§∑</span>
                        <span>Irrelevant</span>
                    </button>
                    <button class="importance-btn ${currentImportance === 'a_little' ? 'selected' : ''}"
                            onclick="setImportance(${question.id}, 'a_little')" title="Nice to align, not crucial">
                        <span class="importance-icon">üëç</span>
                        <span>A Little</span>
                    </button>
                    <button class="importance-btn ${currentImportance === 'somewhat' ? 'selected' : ''}"
                            onclick="setImportance(${question.id}, 'somewhat')" title="I prefer alignment">
                        <span class="importance-icon">üí≠</span>
                        <span>Somewhat</span>
                    </button>
                    <button class="importance-btn ${currentImportance === 'very' ? 'selected' : ''}"
                            onclick="setImportance(${question.id}, 'very')" title="Strong preference">
                        <span class="importance-icon">üí™</span>
                        <span>Very</span>
                    </button>
                    <button class="importance-btn mandatory ${currentImportance === 'mandatory' ? 'selected' : ''}"
                            onclick="setImportance(${question.id}, 'mandatory')" title="Dealbreaker - must align">
                        <span class="importance-icon">üö´</span>
                        <span>Dealbreaker</span>
                    </button>
                </div>
                <div class="importance-hint">
                    <i class="fas fa-info-circle"></i>
                    <span id="importance-hint-text">Questions marked "Dealbreaker" will filter out incompatible matches.</span>
                </div>
            </div>
        `;

        document.getElementById('questions-container').innerHTML = `
            <div class="question-card">
                <div class="question-category" style="font-size: 0.875rem; color: var(--aura-primary); margin-bottom: 0.5rem;">
                    ${question.category || 'General'}
                </div>
                <div class="question-text">${question.text}</div>
                <div class="answer-options">${optionsHtml}</div>
                ${acceptableHtml}
                ${importanceHtml}
            </div>
        `;

        // Update navigation buttons
        document.getElementById('prev-question').disabled = currentQuestionIndex === 0;
        document.getElementById('next-question').innerHTML = currentQuestionIndex === questions.length - 1
            ? '<i class="fas fa-check"></i> Submit'
            : 'Next <i class="fas fa-arrow-right"></i>';
    }

    function setImportance(questionId, level) {
        questionImportance[questionId] = level;
        renderCurrentQuestion();
    }

    function selectAnswer(questionId, optionIndex) {
        answers[questionId] = optionIndex;
        renderCurrentQuestion();
    }

    document.getElementById('prev-question').addEventListener('click', function() {
        if (currentQuestionIndex > 0) {
            currentQuestionIndex--;
            renderCurrentQuestion();
        }
    });

    document.getElementById('next-question').addEventListener('click', async function() {
        if (currentQuestionIndex < questions.length - 1) {
            currentQuestionIndex++;
            renderCurrentQuestion();
        } else {
            // Submit all answers
            await submitAnswers();
        }
    });

    async function submitAnswers() {
        // Build submissions with OKCupid-style importance AND acceptable answers (Marriage Machine feature)
        const submissions = Object.entries(answers).map(([questionId, optionIndex]) => {
            // Get acceptable answers (convert to 1-based for backend)
            const question = questions.find(q => q.id == questionId);
            let acceptable = acceptableAnswers[questionId];
            if (!acceptable) {
                acceptable = getDefaultAcceptable(optionIndex, question?.options?.length || 5);
            }
            // Convert to 1-based indices for backend
            const acceptableOneBased = acceptable.map(i => i + 1);

            return {
                questionId: questionId.toString(),
                numericResponse: optionIndex + 1, // Convert to 1-based for Likert scale
                importance: questionImportance[questionId] || 'somewhat',
                acceptableAnswers: JSON.stringify(acceptableOneBased)
            };
        });

        try {
            const response = await fetch('/intake/questions/submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(submissions)
            });

            if (response.ok) {
                progress.questionsComplete = true;
                updateProgressDisplay();
                showVideoStep();
            } else {
                alert('Failed to submit answers');
            }
        } catch (error) {
            console.error('Failed to submit:', error);
        }
    }

    function showVideoStep() {
        document.getElementById('questions-section').style.display = 'none';
        document.getElementById('video-section').style.display = 'block';

        document.getElementById('step-questions').classList.remove('active');
        document.getElementById('step-video').classList.add('active');
        document.getElementById('step-video-status').innerHTML = '<span class="badge active">In Progress</span>';
    }

    function showPhotosStep() {
        document.getElementById('video-section').style.display = 'none';
        document.getElementById('photos-section').style.display = 'block';

        document.getElementById('step-video').classList.remove('active');
        document.getElementById('step-photos').classList.add('active');
        document.getElementById('step-photos-status').innerHTML = '<span class="badge active">In Progress</span>';
    }

    // ========================================
    // INTRO RECORDING (using WebCapture)
    // ========================================
    let selectedIntroMode = null;

    // Initialize WebCapture event handlers when showing video step
    function initWebCapture() {
        if (typeof WebCapture === 'undefined') {
            console.error('WebCapture not loaded');
            return;
        }

        WebCapture.onStatusChange(handleIntroStatusChange);
        WebCapture.onProgress(handleIntroProgress);
        WebCapture.onError(handleIntroError);
        WebCapture.onComplete(handleIntroComplete);
    }

    function selectIntroMode(mode) {
        selectedIntroMode = mode;
        const isAudioOnly = mode === 'AUDIO_ONLY';

        // Hide mode selection, show recording UI
        document.getElementById('intro-mode-select').style.display = 'none';
        document.getElementById('intro-recording-ui').style.display = 'block';

        // Show appropriate visualizer
        document.getElementById('intro-audio-visualizer').style.display = isAudioOnly ? 'flex' : 'none';
        document.getElementById('intro-video-preview').style.display = isAudioOnly ? 'none' : 'block';

        // Update tips
        if (isAudioOnly) {
            document.getElementById('intro-tips-title').textContent = 'Tips for a great voice intro:';
            document.getElementById('intro-tips-list').innerHTML = `
                <li>Find a quiet spot with minimal background noise</li>
                <li>Speak clearly and at a natural pace</li>
                <li>Share your name, interests, and what you're looking for</li>
                <li>Keep it under 2 minutes</li>
            `;
        } else {
            document.getElementById('intro-tips-title').textContent = 'Tips for a great video intro:';
            document.getElementById('intro-tips-list').innerHTML = `
                <li>Find good lighting (face a window if possible)</li>
                <li>Position your face in the center of the frame</li>
                <li>Share your name, interests, and what you're looking for</li>
                <li>Keep it under 2 minutes</li>
            `;
        }

        // Initialize WebCapture
        initWebCapture();
    }

    function changeIntroMode() {
        if (WebCapture.isRecording()) {
            WebCapture.cancel();
        }
        document.getElementById('intro-mode-select').style.display = 'block';
        document.getElementById('intro-recording-ui').style.display = 'none';
        resetIntroUI();
    }

    async function toggleIntroRecording() {
        if (!WebCapture.isRecording()) {
            try {
                await WebCapture.start({ captureType: selectedIntroMode });

                // Update UI
                document.getElementById('intro-record-btn').classList.add('recording');
                document.getElementById('intro-record-text').textContent = 'Stop Recording';
                document.getElementById('intro-recording-indicator').style.display = 'flex';
                document.getElementById('intro-secondary-controls').style.display = 'flex';

                if (selectedIntroMode === 'AUDIO_ONLY') {
                    document.getElementById('intro-audio-status').innerHTML = '<i class="fas fa-circle" style="color: var(--aura-danger); animation: pulse 1s infinite;"></i> <span>Recording...</span>';
                    document.getElementById('intro-audio-wave').classList.add('active');
                }
            } catch (error) {
                handleIntroError(error);
            }
        } else {
            WebCapture.stop();
        }
    }

    function cancelIntroRecording() {
        if (confirm('Cancel this recording?')) {
            WebCapture.cancel();
            resetIntroUI();
        }
    }

    function resetIntroUI() {
        document.getElementById('intro-record-btn').classList.remove('recording');
        document.getElementById('intro-record-text').textContent = 'Start Recording';
        document.getElementById('intro-recording-indicator').style.display = 'none';
        document.getElementById('intro-secondary-controls').style.display = 'none';
        document.getElementById('intro-upload-progress').style.display = 'none';
        document.getElementById('intro-recording-progress').style.width = '0%';
        document.getElementById('intro-audio-wave').classList.remove('active');
        document.getElementById('intro-audio-status').innerHTML = '<i class="fas fa-microphone"></i> <span>Ready to record</span>';
    }

    function handleIntroStatusChange({ status, message }) {
        console.log('Intro status:', status);

        switch (status) {
            case 'processing':
            case 'uploading':
                document.getElementById('intro-upload-progress').style.display = 'block';
                document.getElementById('intro-upload-text').textContent = 'Uploading...';
                break;
            case 'verifying':
                document.getElementById('intro-upload-text').textContent = 'Verifying...';
                break;
            case 'error':
                alert(message || 'Recording failed. Please try again.');
                resetIntroUI();
                break;
        }
    }

    function handleIntroProgress({ phase, percent, durationMs, durationFormatted }) {
        if (phase === 'recording') {
            document.getElementById('intro-recording-time').textContent = durationFormatted || '0:00';
            const maxSeconds = selectedIntroMode === 'AUDIO_ONLY' ? 120 : 120; // 2 min for both
            const elapsed = Math.floor((durationMs || 0) / 1000);
            const progressPct = Math.min((elapsed / maxSeconds) * 100, 100);
            document.getElementById('intro-recording-progress').style.width = progressPct + '%';
        } else if (phase === 'uploading') {
            document.getElementById('intro-upload-bar').style.width = (percent || 0) + '%';
            document.getElementById('intro-upload-text').textContent = 'Uploading... ' + (percent || 0) + '%';
        }
    }

    function handleIntroError(error) {
        console.error('Intro error:', error);
        alert(error.message || 'An error occurred. Please try again.');
        resetIntroUI();
    }

    function handleIntroComplete({ captureId, fileSizeBytes, durationMs }) {
        console.log('Intro complete:', captureId);

        // Mark as complete and move to next step
        progress.videoIntroComplete = true;
        updateProgressDisplay();
        showPhotosStep();
    }

    function skipIntro() {
        if (confirm('You can always add an intro later from your profile. Skip for now?')) {
            progress.videoIntroComplete = true; // Mark as "complete" (skipped)
            updateProgressDisplay();
            showPhotosStep();
        }
    }

    // Photo upload
    document.getElementById('photo-input').addEventListener('change', async function(e) {
        for (let file of e.target.files) {
            await uploadPhoto(file);
        }
    });

    async function uploadPhoto(file) {
        const formData = new FormData();
        formData.append('file', file);

        try {
            const response = await fetch('/user/userdata/picture', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                // Add photo to grid
                const grid = document.getElementById('photos-grid');
                const slot = document.createElement('div');
                slot.className = 'photo-slot';
                slot.innerHTML = `<img src="${URL.createObjectURL(file)}" alt="Photo">`;
                grid.insertBefore(slot, grid.lastElementChild);

                // Mark photos as complete
                progress.picturesComplete = true;
                updateProgressDisplay();
            }
        } catch (error) {
            console.error('Failed to upload photo:', error);
        }
    }
</script>

</body>
</html>
