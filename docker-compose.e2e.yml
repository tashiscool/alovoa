# ============================================================
# AURA Platform E2E Test Stack
# ============================================================
# Complete environment for end-to-end testing with all services
#
# Services:
#   - aura-app: Main Java/Spring Boot application
#   - media-service: Python face verification & video processing
#   - ai-service: Python ML compatibility scoring
#   - mariadb: Primary database
#   - redis: Caching layer
#   - minio: S3-compatible object storage
#
# Usage:
#   docker compose -f docker-compose.e2e.yml up -d --build
#   python e2e/test_platform.py
#   docker compose -f docker-compose.e2e.yml down -v
# ============================================================

services:
  # ===========================================
  # Infrastructure Services
  # ===========================================

  mariadb:
    image: mariadb:11
    container_name: aura-e2e-db
    ports:
      - "3306:3306"
    environment:
      MARIADB_ROOT_PASSWORD: root
      MARIADB_DATABASE: alovoa
      MARIADB_USER: alovoa
      MARIADB_PASSWORD: alovoa_e2e
    tmpfs:
      - /var/lib/mysql:rw
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 5s
      timeout: 5s
      retries: 20
    networks:
      - aura-e2e-network

  redis:
    image: redis:7-alpine
    container_name: aura-e2e-redis
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - aura-e2e-network

  minio:
    image: minio/minio:latest
    container_name: aura-e2e-minio
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: aura_e2e_admin
      MINIO_ROOT_PASSWORD: aura_e2e_secret
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - aura-e2e-network

  minio-init:
    image: minio/mc:latest
    container_name: aura-e2e-minio-init
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set aura http://minio:9000 aura_e2e_admin aura_e2e_secret;
      mc mb aura/aura-media --ignore-existing;
      mc mb aura/aura-video --ignore-existing;
      mc mb aura/aura-profiles --ignore-existing;
      mc anonymous set download aura/aura-media;
      echo 'MinIO buckets created successfully';
      exit 0;
      "
    networks:
      - aura-e2e-network

  # ===========================================
  # Python Microservices
  # ===========================================

  media-service:
    build:
      context: ./services/media-service
      dockerfile: Dockerfile
    container_name: aura-e2e-media
    ports:
      - "8001:8001"
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      STORAGE_PATH: /data/media
      FACE_MODEL: Facenet512
      DETECTOR_BACKEND: opencv
      FACE_MATCH_THRESHOLD: 0.70
      LIVENESS_THRESHOLD: 0.75
      DEEPFAKE_THRESHOLD: 0.75
      # Use MinIO for S3 storage
      S3_ENDPOINT: http://minio:9000
      S3_ACCESS_KEY: aura_e2e_admin
      S3_SECRET_KEY: aura_e2e_secret
      S3_BUCKET: aura-media
    volumes:
      - media-storage:/data/media
    depends_on:
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 10s
      timeout: 5s
      retries: 15
    networks:
      - aura-e2e-network

  ai-service:
    build:
      context: ./services/ai-service
      dockerfile: Dockerfile
    container_name: aura-e2e-ai
    ports:
      - "8002:8002"
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      EMBEDDING_DIM: 128
      PERSONALITY_WEIGHT: 0.30
      VALUES_WEIGHT: 0.25
      LIFESTYLE_WEIGHT: 0.20
      ATTRACTION_WEIGHT: 0.15
      CIRCUMSTANTIAL_WEIGHT: 0.10
      # Disable external AI APIs for testing
      OPENAI_API_KEY: ""
      ANTHROPIC_API_KEY: ""
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 10s
      timeout: 5s
      retries: 15
    networks:
      - aura-e2e-network

  # ===========================================
  # Main Java Application
  # ===========================================

  aura-app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: aura-e2e-app
    ports:
      - "8080:8080"
    # Override entrypoint to increase memory (base Dockerfile has -Xmx128m which is too small)
    entrypoint: ["java", "-XX:+HeapDumpOnOutOfMemoryError", "-Xms256m", "-Xmx1024m", "-jar", "-Dfile.encoding=UTF-8", "alovoa-1.1.0.jar"]
    environment:
      SPRING_PROFILES_ACTIVE: e2e
      SPRING_DATASOURCE_URL: jdbc:mariadb://mariadb:3306/alovoa?serverTimezone=UTC
      SPRING_DATASOURCE_USERNAME: alovoa
      SPRING_DATASOURCE_PASSWORD: alovoa_e2e
      SPRING_REDIS_HOST: redis
      SPRING_REDIS_PORT: 6379
      # Service URLs
      APP_AURA_MEDIA_SERVICE_URL: http://media-service:8001
      APP_AURA_AI_SERVICE_URL: http://ai-service:8002
      # AURA Feature Flags
      APP_AURA_DAILY_MATCH_LIMIT: 10
      APP_AURA_VIDEO_VERIFICATION_ENABLED: "true"
      APP_AURA_REPUTATION_ENABLED: "true"
      APP_AURA_SCAFFOLDING_ENABLED: "true"
      # S3 Storage (MinIO)
      APP_STORAGE_S3_ENABLED: "true"
      APP_STORAGE_S3_ENDPOINT: http://minio:9000
      APP_STORAGE_S3_ACCESS_KEY: aura_e2e_admin
      APP_STORAGE_S3_SECRET_KEY: aura_e2e_secret
      APP_STORAGE_S3_BUCKET: aura-profiles
      APP_STORAGE_S3_REGION: us-east-1
      # Encryption keys for testing
      APP_TEXT_KEY: bqupWgmhCj3fedLxYdNAy2QFA2bS9XJX
      APP_TEXT_SALT: sFRKQAhwdrZq44FQ
      # Admin credentials
      APP_ADMIN_EMAIL: admin@aura-test.local
      APP_ADMIN_KEY: e2e_admin_password
      # Disable rate limiting for tests
      BUCKET4J_ENABLED: "false"
      # OAuth2 dummy credentials (required for app startup, not used in E2E tests)
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT_ID: e2e-test-google-client-id
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT_SECRET: e2e-test-google-client-secret
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_FACEBOOK_CLIENT_ID: e2e-test-facebook-client-id
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_FACEBOOK_CLIENT_SECRET: e2e-test-facebook-client-secret
    depends_on:
      mariadb:
        condition: service_healthy
      redis:
        condition: service_healthy
      media-service:
        condition: service_healthy
      ai-service:
        condition: service_healthy
      minio-init:
        condition: service_completed_successfully
    healthcheck:
      # Using wget instead of curl (eclipse-temurin doesn't have curl by default)
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/actuator/health"]
      interval: 15s
      timeout: 10s
      retries: 20
      start_period: 90s
    networks:
      - aura-e2e-network

volumes:
  media-storage:

networks:
  aura-e2e-network:
    driver: bridge
